#! /bin/sh -vx
#
# Copyright 2022 TANAKA Takuji <ttk@t-lab.opal.ne.jp>
# You may freely use, modify and/or distribute this file.

test -d tests || mkdir -p tests

rc=0
bb=

TEXMFCNF=$srcdir/../kpathsea
#${BSTINPUTS:=.:/usr/share/texlive/texmf-dist//}
#${BIBINPUTS:=.:/usr/share/texlive/texmf-dist//}
${BSTINPUTS:=.:~/Softs/texjporg/pbibtex-base/encoding-utf8//}
${BIBINPUTS:=.:~/Softs/texjporg/pbibtex-base/encoding-utf8//}
export TEXMFCNF BSTINPUTS BIBINPUTS

BIBTEX="./bibtexu"

## test for Japanese example
for bst in jabbrv jplain jalpha junsrt jname jipsj tieice tipsj jorsj; do

  job=jxampl-$bst-bu
  cp $srcdir/bibtests/$job.aux tests/$job.aux
  $BIBTEX tests/$job || test $? = 1 \
   && diff $srcdir/bibtests/$job.bbl tests/$job.bbl || { rc=1 ; bb=$bb,$bst ; }

done

for bst in jabbrv jplain jalpha junsrt jname jipsj tieice tipsj jorsj; do\

  job=jxampl-$bst-bu
  cp $srcdir/bibtests/$job.aux tests/$job-wide.aux
  max_print_line=399 ${BIBTEX} tests/$job-wide || test $? = 1 \
   && diff $srcdir/bibtests/$job-wide.bbl tests/$job-wide.bbl || { rc=2 ; bb=$bb,$bst-w ; }

done


if [ $rc -gt 0 ]; then
  if [ -n "$bb" ]; then
    echo ERROR in bibtexu $bb
  fi
else
  echo SUCCESS
fi
exit $rc
