#! /bin/sh -vx
#
# Copyright 2022 Japanese TeX Development Community <issue@texjp.org>
# You may freely use, modify and/or distribute this file.

test -d ptests || mkdir -p ptests
rm -f ptests/fn*.log ptests/fn*.txt

rc=0

TEXMFCNF=$srcdir/../kpathsea
TEXINPUTS=$srcdir/ptexdir/tests:.
export TEXMFCNF TEXINPUTS

# pTeX internal encoding
fenc="utf8"
for ienc in euc sjis; do
for doc in fn fnさざ波; do

  echo '>>> Document:'$doc '  File Encoding:'$fenc '  Internal Encoding:'$ienc
  ./ptex -ini -interaction nonstopmode -jobname=$doc-$ienc -kanji=$fenc --kanji-internal=$ienc $doc.tex >ptests/$doc-$ienc-term.log || $rc=1
  mv $doc-$ienc.txt $doc-$ienc.log ptests/
  diff ptests/$doc-$ienc.txt $srcdir/ptexdir/tests/fn-utf8.txt || $rc=2

done
done

# pTeX, regacy encoding
for fenc in sjis euc jis utf8; do
for doc in fnさざ波-$fenc; do

  ienc=$fenc
  if [ "$COMSPEC" != "" ]; then
    echo "*** We guess OS is Windows."
    if [ $fenc != euc ]; then ienc="sjis"; fi
  else
    echo "*** We guess OS is not Windows."
    if [ $fenc != sjis ]; then ienc="euc"; fi
  fi

  echo '>>> Document:'$doc '  File Encoding:'$fenc '  Internal Encoding:'$ienc
  ./ptex -ini -interaction nonstopmode -jobname=$doc-$ienc -kanji=$fenc --kanji-internal=$ienc $doc.tex >ptests/$doc-$fenc-term.log || $rc=3
  mv $doc-$ienc.txt $doc-$ienc.log ptests/
  diff ptests/$doc-$ienc.txt $srcdir/ptexdir/tests/fn-$fenc.txt || $rc=4

done
done


# pTeX, CP932 characters
for fenc in sjis; do
for doc in fn①㎝Ⅶ閒ｱ～-$fenc; do

  ienc=$fenc
  if [ "$COMSPEC" != "" ]; then
    echo "*** We guess OS is Windows."
    if [ $fenc != euc ]; then ienc="sjis"; fi
  else
    echo "*** We guess OS is not Windows."
    if [ $fenc != sjis ]; then ienc="euc"; fi
  fi

  echo '>>> Document:'$doc '  File Encoding:'$fenc '  Internal Encoding:'$ienc
  ./ptex -ini -interaction nonstopmode -jobname=$doc-$ienc -kanji=$fenc --kanji-internal=$ienc $doc.tex >ptests/$doc-$fenc-term.log || $rc=3
  mv $doc*.txt $doc-$ienc.log ptests/
  diff ptests/$doc-$ienc.txt $srcdir/ptexdir/tests/fn-$fenc.txt || $rc=4

done
done

exit $rc
