#! /bin/sh -vx
#
# Copyright 2022 TANAKA Takuji <ttk@t-lab.opal.ne.jp>
# You may freely use, modify and/or distribute this file.

test -d uptests || mkdir -p uptests

rc=0

TEXMFCNF=$srcdir/../kpathsea
BSTINPUTS=$srcdir/bibtests
BIBINPUTS=$srcdir/bibtests
export TEXMFCNF BSTINPUTS BIBINPUTS


## test for sorting and change.case$
cp $srcdir/bibtests/sortu.aux uptests/xsortu.aux
./upbibtex uptests/xsortu || rc=51
diff $srcdir/bibtests/sortu.bbl uptests/xsortu.bbl || rc=52

## test for change.case$
cp $srcdir/bibtests/caseu.aux uptests/xcaseu.aux
max_print_line=99 ./upbibtex uptests/xcaseu || rc=53
diff $srcdir/bibtests/caseu.bbl uptests/xcaseu.bbl || rc=54

## test for add.period$
cp $srcdir/bibtests/periodu.aux uptests/xperiodu.aux
./upbibtex uptests/xperiodu || rc=3
diff $srcdir/bibtests/periodu.bbl uptests/xperiodu.bbl || rc=4

## test for substring$
cp $srcdir/bibtests/substru.aux uptests/xsubstru.aux
max_print_line=99 ./upbibtex uptests/xsubstru || rc=5
diff $srcdir/bibtests/substru.bbl uptests/xsubstru.bbl || rc=6

## test for text.length$, text.prefix$
cp $srcdir/bibtests/txtprfxu.aux uptests/xtxtprfxu.aux
max_print_line=99 ./upbibtex uptests/xtxtprfxu || rc=7
diff $srcdir/bibtests/txtprfxu.bbl uptests/xtxtprfxu.bbl || rc=8

## test for width$
cp $srcdir/bibtests/widthu.aux uptests/xwidthu.aux
./upbibtex uptests/xwidthu || rc=9
diff $srcdir/bibtests/widthu.bbl uptests/xwidthu.bbl || rc=10

## test for chr.to.int$, int.to.str$, int.to.chr$
cp $srcdir/bibtests/charu.aux uptests/xcharu.aux
./upbibtex uptests/xcharu
### || rc=11
### It results errors.
diff $srcdir/bibtests/charu.bbl uptests/xcharu.bbl || rc=12

## test for num.names$, format.name$
cp $srcdir/bibtests/nameu.aux tests/xnameu.aux
max_print_line=119 ./upbibtex tests/xnameu || rc=13
diff $srcdir/bibtests/nameu.bbl tests/xnameu.bbl || rc=14

## test for is.knj.str$
cp $srcdir/bibtests/isknju.aux uptests/xisknju.aux
./upbibtex uptests/xisknju || rc=15
diff $srcdir/bibtests/isknju.bbl uptests/xisknju.bbl || rc=16


exit $rc

